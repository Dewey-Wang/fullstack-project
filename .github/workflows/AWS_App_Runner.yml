name: Deploy to AWS App Runner

on:
  push:
    branches:
      - main  # ç•¶ push åˆ° main åˆ†æ”¯æ™‚è§¸ç™¼éƒ¨ç½²

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸš€ æª¢å‡ºç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: ğŸ” è¨­å®š AWS CLI
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: ğŸ³ ç™»å…¥ AWS ECR
        run: |
          aws ecr get-login-password --region ${{ secrets.AWS_REGION }} | docker login --username AWS --password-stdin ${{ secrets.ECR_REPO }}

      - name: ğŸ—ï¸ å»ºç«‹ä¸¦æ¨é€ Docker Image åˆ° AWS ECR
        run: |
          docker buildx create --use
          docker buildx inspect --bootstrap
          docker buildx build --platform linux/amd64 -t ${{ secrets.ECR_REPO }}/giftwebsite:latest --push ./giftwebsite

      - name: ğŸ”§ éƒ¨ç½²åˆ° AWS App Runner
        run: |
          SERVICE_ARN=$(aws apprunner list-services --query "ServiceSummaryList[?ServiceName=='giftwebsite'].ServiceArn" --output text)

          if [ -z "$SERVICE_ARN" ]; then
            echo "â³ å‰µå»ºæ–°çš„ App Runner æœå‹™..."
            aws apprunner create-service \
              --service-name giftwebsite \
              --source-configuration ImageRepository="{ImageIdentifier=${{ secrets.ECR_REPO }}/giftwebsite:latest,ImageRepositoryType=ECR}" \
              --region ${{ secrets.AWS_REGION }}
          else
            echo "ğŸ”„ æ›´æ–°ç¾æœ‰çš„ App Runner æœå‹™..."
            aws apprunner update-service \
              --service-arn "$SERVICE_ARN" \
              --source-configuration ImageRepository="{ImageIdentifier=${{ secrets.ECR_REPO }}/giftwebsite:latest,ImageRepositoryType=ECR}" \
              --region ${{ secrets.AWS_REGION }}
          fi

      - name: ğŸ—ï¸ ç­‰å¾… App Runner éƒ¨ç½²å®Œæˆ
        run: |
          echo "âŒ› ç­‰å¾… App Runner æœå‹™å•Ÿå‹•..."
          sleep 60  # ç­‰å¾… 1 åˆ†é˜è®“ App Runner å®Œæˆéƒ¨ç½²

          APP_URL=$(aws apprunner list-services --query "ServiceSummaryList[?ServiceName=='giftwebsite'].ServiceUrl" --output text)

          if [ -z "$APP_URL" ]; then
            echo "âŒ éƒ¨ç½²å¤±æ•—ï¼Œç„¡æ³•å–å¾— App Runner URL"
            exit 1
          fi

          echo "âœ… App Runner éƒ¨ç½²å®Œæˆï¼Œç¶²å€ç‚º: $APP_URL"
          echo "APP_URL=$APP_URL" >> $GITHUB_ENV

      - name: ğŸ“ æ›´æ–° README.md é¡¯ç¤ºéƒ¨ç½²ç¶²å€
        run: |
          APP_URL=$(cat $GITHUB_ENV | grep APP_URL | cut -d '=' -f2)
          echo "### ğŸš€ GiftWebsite éƒ¨ç½²æˆåŠŸ ğŸ‰" > README.md
          echo "" >> README.md
          echo "æ‡‰ç”¨ç¨‹å¼å·²æˆåŠŸéƒ¨ç½²è‡³ AWS App Runnerã€‚" >> README.md
          echo "" >> README.md
          echo "ğŸ”— [é»æ“Šé€™è£¡è¨ªå• GiftWebsite]($APP_URL)" >> README.md

      - name: ğŸš€ Commit æ›´æ–°çš„ README.md
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "æ›´æ–° README.md: éƒ¨ç½²ç¶²å€"
          git push
