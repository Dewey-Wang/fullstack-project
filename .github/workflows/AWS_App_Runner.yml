name: Deploy to AWS severless

on:
  push:
    branches:
      - main  # ç•¶ push åˆ° main åˆ†æ”¯æ™‚è§¸ç™¼éƒ¨ç½²

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸš€ æª¢å‡ºç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: ğŸ” è¨­å®š AWS CLI
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: ğŸ›  å®‰è£ eksctl
        run: |
          curl --silent --location "https://github.com/weaveworks/eksctl/releases/latest/download/eksctl_$(uname -s)_amd64.tar.gz" | tar xz -C /tmp
          sudo mv /tmp/eksctl /usr/local/bin
          eksctl version  # ç¢ºèª eksctl å®‰è£æˆåŠŸ

      - name: ğŸ³ ç™»å…¥ AWS ECR
        run: |
          aws ecr get-login-password --region ${{ secrets.AWS_REGION }} | docker login --username AWS --password-stdin ${{ secrets.ECR_REPO }}

      - name: âš™ï¸ æª¢æŸ¥ä¸¦å»ºç«‹ AWS EKS å¢é›†
        run: |
          eksctl get cluster --name giftapp-cluster || eksctl create cluster --name giftapp-cluster --region ${{ secrets.AWS_REGION }} --nodegroup-name giftapp-nodes --node-type t3.medium --nodes 2

      - name: ğŸ”§ è¨­å®š Kubeconfig
        run: aws eks update-kubeconfig --region ${{ secrets.AWS_REGION }} --name giftapp-cluster

      - name: ğŸ—ï¸ å»ºç«‹ ecr-access ServiceAccount ä¸¦ç¶å®š IAM
        run: |
          eksctl create iamserviceaccount \
            --name ecr-access \
            --namespace default \
            --cluster giftapp-cluster \
            --attach-policy-arn arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly \
            --override-existing-serviceaccounts \
            --approve

          echo "âœ… ServiceAccount ecr-access å·²å»ºç«‹ï¼"

      - name: â¬†ï¸ éƒ¨ç½² MongoDB åˆ° AWS EKS
        run: |
          kubectl apply -f ./kubernetes/deploymongo.yml
          
          echo "âŒ› ç­‰å¾… MongoDB éƒ¨ç½²å®Œæˆ..."

          echo "ğŸ” æª¢æŸ¥ MongoDB Pods ç‹€æ…‹..."
          kubectl get pods

          # å–å¾— MongoDB Pod çš„ç‹€æ…‹
          POD_STATUS=$(kubectl get pods -l app=mongodb -o jsonpath='{.items[0].status.phase}')
          
          if [ "$POD_STATUS" != "Running" ]; then
            echo "âŒ MongoDB Pod æœªèƒ½æˆåŠŸå•Ÿå‹•ï¼Œç•¶å‰ç‹€æ…‹: $POD_STATUS"
            kubectl describe pod -l app=mongodb  # é¡¯ç¤ºè©³ç´°éŒ¯èª¤è³‡è¨Š
            exit 1  # è®“ GitHub Actions å¤±æ•—ï¼Œé˜²æ­¢ç¹¼çºŒåŸ·è¡Œ
          fi

          echo "âœ… MongoDB å·²æˆåŠŸé‹è¡Œï¼"

      - name: ğŸ—ï¸ å»ºç«‹ Backend Docker Image ä¸¦æ¨é€åˆ° AWS ECR (linux/amd64)
        run: |
          docker buildx create --use
          docker buildx inspect --bootstrap
          docker buildx build --platform linux/amd64 -t ${{ secrets.ECR_REPO }}/giftapp-backend:latest --push ./giftlink-backend

      - name: ğŸ“¦ å®‰è£ Express å’Œ CORS åœ¨ giftwebsite
        run: |
          cd ./giftwebsite
          npm install express cors
          cd ..

      - name: ğŸ”§ æ›´æ–° `deployment.yml` ä¸­çš„ Image è·¯å¾‘
        run: |
          ECR_URL="${{ secrets.ECR_REPO }}"
          sed -i "s|<ECR_URL>|$ECR_URL|g" ./kubernetes/deployment.yml
          cat ./kubernetes/deployment.yml  # ç¢ºä¿å…§å®¹å·²æ›´æ–°
      
      - name: ğŸ—ï¸ å‰µå»º AWS ECR Secretï¼Œä¾› Kubernetes æ‹‰å–æ˜ åƒ
        run: |
          kubectl delete secret aws-ecr-secret --ignore-not-found
          kubectl create secret docker-registry aws-ecr-secret \
            --docker-server=${{ secrets.ECR_REPO }} \
            --docker-username=AWS \
            --docker-password=$(aws ecr get-login-password --region ${{ secrets.AWS_REGION }}) \
            --dry-run=client -o yaml | kubectl apply -f -
          
          echo "âœ… AWS ECR Secret å·²å»ºç«‹ï¼"

      - name: â¬†ï¸ éƒ¨ç½² Backend åˆ° AWS EKS
        run: |
          kubectl delete deployment giftapp
          kubectl apply -f ./kubernetes/deployment.yml
          kubectl get pods -o wide
          kubectl get nodes -o wide

      - name: ğŸ› ï¸ æª¢æŸ¥ä¸¦ä¿®å¾© Kubernetes ç¯€é»ç‹€æ…‹
        run: |
          echo "ğŸ” æª¢æŸ¥ Kubernetes ç¯€é»ç‹€æ…‹..."
          kubectl get nodes -o wide

          # æ‰¾å‡º NotReady æˆ– SchedulingDisabled çš„ç¯€é»
          BAD_NODES=$(kubectl get nodes --no-headers | awk '$2 ~ /NotReady|SchedulingDisabled/ {print $1}')

          if [ -n "$BAD_NODES" ]; then
            echo "âš ï¸ ä»¥ä¸‹ç¯€é»è™•æ–¼ NotReady æˆ– SchedulingDisabled ç‹€æ…‹:"
            echo "$BAD_NODES"

            for NODE in $BAD_NODES; do
              echo "ğŸ› ï¸ ä¿®å¾©ç¯€é»: $NODE"
              
              # é¡¯ç¤ºç¯€é»è©³ç´°è³‡è¨Š
              kubectl describe node "$NODE"

              # ç§»é™¤ taints è®“ Pod å¯ä»¥èª¿åº¦
              kubectl taint nodes "$NODE" node.kubernetes.io/not-ready:NoExecute- || true
              kubectl taint nodes "$NODE" node.kubernetes.io/unreachable:NoExecute- || true
              kubectl uncordon "$NODE" || true
            done

            echo "â³ ç­‰å¾…ç¯€é»æ¢å¾© Ready ç‹€æ…‹..."
            sleep 30
            kubectl get nodes -o wide
          else
            echo "âœ… æ‰€æœ‰ç¯€é»å‡æ­£å¸¸"
          fi


      - name: ğŸ—ï¸ ç­‰å¾… giftapp éƒ¨ç½²å®Œæˆ
        run: |
          echo "âŒ› ç­‰å¾… giftapp éƒ¨ç½²å®Œæˆ..."
          kubectl rollout status deployment giftapp --timeout=120s || (echo "âŒ giftapp éƒ¨ç½²å¤±æ•—ï¼Œé¡¯ç¤º Pod ç‹€æ…‹ï¼š" && kubectl get pods && kubectl describe pod -l app=giftapp && exit 1)

          echo "ğŸ” æª¢æŸ¥ LoadBalancer..."
          BACKEND_URL=$(kubectl get svc gift-app-service -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')

          if [ -z "$BACKEND_URL" ]; then
            echo "âŒ LoadBalancer å°šæœªæº–å‚™å¥½ï¼Œè«‹ç¨å¾Œå†è©¦"
            kubectl get svc gift-app-service
            exit 1
          fi

          BACKEND_URL="http://$BACKEND_URL"
          echo "âœ… æœå‹™å·²å•Ÿå‹•ï¼Œç¶²å€ç‚ºï¼š$BACKEND_URL"
          echo "BACKEND_URL=$BACKEND_URL" >> $GITHUB_ENV

      - name: ğŸ“ æ›´æ–° giftlink-frontend env
        run: |
          echo "REACT_APP_BACKEND_URL=$BACKEND_URL" > ./giftlink-frontend/.env
          cat giftlink-frontend/.env  # ç¢ºèªå…§å®¹æ˜¯å¦æ›´æ–°æˆåŠŸ
      
      - name: ğŸ“¦ å®‰è£express and cors in giftwebsite
        run: |
          cd ./giftwebsite
          npm install express cors
          cd ..
          
      - name: ğŸ“¦ å®‰è£æ‰€æœ‰å¿…è¦çš„ packages in giftlink-frontend
        run: |
          cd ./giftlink-frontend
          npm install
          npm run build
          cd ..

      - name: ğŸ—ï¸ å»ºç«‹ giftwebsite Docker Image ä¸¦æ¨é€åˆ° AWS ECR (linux/amd64)
        run: |
          docker buildx create --use
          docker buildx inspect --bootstrap
          docker buildx build --platform linux/amd64 -t ${{ secrets.ECR_REPO }}/giftwebsite:latest --push ./giftwebsite
    
      - name: ğŸ”§ æ›´æ–° `giftwebsite-deployment.yml` ä¸­çš„ Image è·¯å¾‘
        run: |
          ECR_URL="${{ secrets.ECR_REPO }}"
          sed -i "s|<ECR_URL>|$ECR_URL|g" ./kubernetes/giftwebsite-deployment.yml
          cat ./kubernetes/giftwebsite-deployment.yml  # ç¢ºä¿å…§å®¹å·²æ›´æ–°
      
      - name: â¬†ï¸ éƒ¨ç½² giftwebsite åˆ° AWS EKS
        run: |
         # ç¢ºä¿ giftwebsite Deployment å­˜åœ¨
          kubectl delete deployment giftwebsite
          kubectl apply -f ./kubernetes/giftwebsite-deployment.yml
          kubectl get pods -o wide
          kubectl get nodes -o wide
          kubectl describe pod -l app=giftwebsite
          kubectl get events --sort-by=.metadata.creationTimestamp

      - name: ğŸš€ éƒ¨ç½² giftwebsite åˆ° AWS App Runner
        run: |
          SERVICE_ARN=$(aws apprunner list-services --query "ServiceSummaryList[?ServiceName=='giftwebsite'].ServiceArn" --output text --region ${{ secrets.AWS_REGION }})
          
          if [ -z "$SERVICE_ARN" ]; then
            echo "ğŸ”„ å‰µå»º App Runner æœå‹™..."
            aws apprunner create-service \
              --service-name giftwebsite \
              --source-configuration '{
                "ImageRepository": {
                  "ImageIdentifier": "${{ secrets.ECR_REPO }}/giftwebsite:latest",
                  "ImageRepositoryType": "ECR",
                  "ImageConfiguration": {
                    "Port": "9000"
                  }
                },
                "AuthenticationConfiguration": {
                  "AccessRoleArn": "arn:aws:iam::253490795451:role/AppRunnerECRAccess"
                }
              }' \
              --region ${{ secrets.AWS_REGION }}
          else
            echo "ğŸ”„ æ›´æ–° App Runner æœå‹™..."
            aws apprunner update-service \
              --service-arn "$SERVICE_ARN" \
              --source-configuration '{
                "ImageRepository": {
                  "ImageIdentifier": "${{ secrets.ECR_REPO }}/giftwebsite:latest",
                  "ImageRepositoryType": "ECR",
                  "ImageConfiguration": {
                    "Port": "9000"
                  }
                },
                "AuthenticationConfiguration": {
                  "AccessRoleArn": "arn:aws:iam::253490795451:role/AppRunnerECRAccess"
                }
              }' \
              --region ${{ secrets.AWS_REGION }}
          fi

          echo "âŒ› ç­‰å¾… App Runner éƒ¨ç½²å®Œæˆ..."
          sleep 30

          # å–å¾— App Runner æœå‹™çš„ç¶²å€
          GIFTWEBSITE_URL=$(aws apprunner list-services --query "ServiceSummaryList[?ServiceName=='giftwebsite'].ServiceUrl" --output text --region ${{ secrets.AWS_REGION }})

          if [ -z "$GIFTWEBSITE_URL" ]; then
            echo "âŒ App Runner éƒ¨ç½²å¤±æ•—"
            exit 1
          fi

          echo "âœ… GiftWebsite å¯åœ¨é€™è£¡è¨ªå•: $GIFTWEBSITE_URL"
          echo "GIFTWEBSITE_URL=$GIFTWEBSITE_URL" >> $GITHUB_ENV



      - name: ğŸ“ æ›´æ–° README.md é¡¯ç¤ºç¶²ç«™ç¶²å€
        run: |
          echo "# ğŸ GiftWebsite" > README.md
          echo "" >> README.md
          echo "âœ… ä½ çš„ç¶²ç«™å·²éƒ¨ç½² ğŸ‰" >> README.md
          echo "" >> README.md
          echo "ğŸ”— **ç¶²å€ï¼š[$GIFTWEBSITE_URL]($GIFTWEBSITE_URL)**" >> README.md
          echo "" >> README.md
          echo "ğŸš€ æ¯æ¬¡ Push åˆ° main éƒ½æœƒè‡ªå‹•éƒ¨ç½²åˆ° AWS App Runnerï¼" >> README.md
          
          git config --global user.name 'github-actions'
          git config --global user.email 'github-actions@github.com'
          git add README.md
          git commit -m "æ›´æ–° README.mdï¼Œé¡¯ç¤ºæœ€æ–°çš„éƒ¨ç½²ç¶²å€"

          # **ä½¿ç”¨ GitHub Token æˆæ¬Š**
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          git push
