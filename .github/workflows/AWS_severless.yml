name: Completely Deploy to AWS Serverless

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸš€ æª¢å‡ºç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: ğŸ” è¨­å®š AWS CLI
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: ğŸ“¦ å®‰è£ AWS SDK v3 & dotenv
        run: |
          cd giftlink-backend
          npm uninstall aws-sdk
          npm install @aws-sdk/client-dynamodb @aws-sdk/lib-dynamodb dotenv
          cd ..
      - name: ğŸ”§ æ›´æ–° `util/import-mongo/.env`
        run: |
          cat <<EOF > giftlink-backend/util/import-mongo/.env
          DYNAMODB_TABLE=giftapp-data
          DATASRC=gifts.json
          EOF
      - name: ğŸ”§ ç¢ºä¿ `.env` è¨­ç½® `DYNAMODB_TABLE`
        run: |
          cat <<EOF > giftlink-backend/.env
          DYNAMODB_TABLE=giftapp-data
          JWT_SECRET=mysecret
          EOF
          
      - name: ğŸ”„ è¼¸å‡º `.env` ä¾†ç¢ºèªè¨­å®š
        run: cat giftlink-backend/.env

      - name: ğŸ”§ ä¿®æ­£ `index.js` ç¢ºä¿ `.env` æ­£ç¢ºè¼‰å…¥
        run: |
          cat <<EOF > giftlink-backend/util/import-mongo/index.js
          require("dotenv").config({ path: "giftlink-backend/util/import-mongo/.env" });
          const fs = require("fs");
          const { DynamoDBClient } = require("@aws-sdk/client-dynamodb");
          const { DynamoDBDocumentClient, PutCommand } = require("@aws-sdk/lib-dynamodb");
          const TABLE_NAME = process.env.DYNAMODB_TABLE;
          if (!TABLE_NAME) {
              console.error("âŒ DYNAMODB_TABLE æœªè¨­ç½®ï¼Œè«‹ç¢ºèª .env");
              process.exit(1);
          }
          const client = new DynamoDBClient({ region: process.env.AWS_REGION });
          const dynamoDB = DynamoDBDocumentClient.from(client);
          async function loadData() {
              console.log("ğŸ“¥ è®€å– `gifts.json`...");
              const giftsFilePath = "giftlink-backend/util/import-mongo/gifts.json";
              const giftsData = JSON.parse(fs.readFileSync(giftsFilePath, "utf8")).docs;
              console.log("ğŸš€ é–‹å§‹å¯«å…¥ DynamoDB...");
              for (const gift of giftsData) {
                  await dynamoDB.send(new PutCommand({ TableName: TABLE_NAME, Item: gift }));
                  console.log(\`âœ… å·²å¯«å…¥: \${gift.name}\`);
              }
              console.log("âœ… `gifts.json` æ•¸æ“šå·²æˆåŠŸå°å…¥ DynamoDBï¼");
          }
          loadData().catch(console.error);
          EOF
      - name: ğŸ”§ æ›´æ–° `models/db.js`
        run: |
          cat <<EOF > giftlink-backend/models/db.js
          require("dotenv").config();
          const { DynamoDBClient } = require("@aws-sdk/client-dynamodb");
          const { DynamoDBDocumentClient, ScanCommand, PutCommand } = require("@aws-sdk/lib-dynamodb");
          
          const client = new DynamoDBClient({
              region: process.env.AWS_REGION,
              credentials: {
                  accessKeyId: process.env.AWS_ACCESS_KEY_ID,
                  secretAccessKey: process.env.AWS_SECRET_ACCESS_KEY,
              },
          });
          
          const db = DynamoDBDocumentClient.from(client);
          const TABLE_NAME = process.env.DYNAMODB_TABLE;
          
          async function getGifts() {
              const params = new ScanCommand({ TableName: TABLE_NAME });
              const data = await db.send(params);
              return data.Items;
          }
          
          async function addGift(gift) {
              const params = new PutCommand({ TableName: TABLE_NAME, Item: gift });
              await db.send(params);
              return gift;
          }
          
          module.exports = { getGifts, addGift };
          EOF
      - name: ğŸ”§ æ›´æ–° `.env`ï¼Œç§»é™¤ MongoDB ä¸¦æ·»åŠ  DynamoDB
        run: |
          cat <<EOF > giftlink-backend/.env
          DYNAMODB_TABLE=giftapp-data
          AWS_REGION=${{ secrets.AWS_REGION }}
          JWT_SECRET=mysecret
          EOF
     
      - name: ğŸ”§ æ›´æ–° `app.js` ä¾†æ”¯æ´ DynamoDB
        run: |
          cat <<EOF > giftlink-backend/app.js
          /*jshint esversion: 8 */
          require("dotenv").config();
          const express = require("express");
          const cors = require("cors");
          const pinoLogger = require("./logger");
          const { DynamoDBClient } = require("@aws-sdk/client-dynamodb");
          const { DynamoDBDocumentClient, ScanCommand, PutCommand, QueryCommand } = require("@aws-sdk/lib-dynamodb");
          const bcryptjs = require("bcryptjs");
          const jwt = require("jsonwebtoken");
          
          const app = express();
          app.use(cors());
          app.use(express.json());
          app.use(require("pino-http")({ logger: pinoLogger }));
          
          const port = process.env.PORT || 3060;
          const TABLE_USERS = "giftapp-users";
          const TABLE_GIFTS = "giftapp-gifts";
          
          const client = new DynamoDBClient({ region: process.env.AWS_REGION });
          const db = DynamoDBDocumentClient.from(client);
          
          // ===============================
          // ğŸ  API Health Check
          // ===============================
          app.get("/", (req, res) => {
            res.send("Inside the server - Now using DynamoDB!");
          });

                  // ===============================
          // ğŸ”’ Authentication Routes
          // ===============================
          // ğŸ“Œ User Registration
          app.post("/api/auth/register", async (req, res) => {
            try {
              const { email, firstName, lastName, password } = req.body;

              // æŸ¥æ‰¾ç”¨æˆ¶æ˜¯å¦å·²å­˜åœ¨
              const existingUsers = await db.send(
                new ScanCommand({
                  TableName: TABLE_USERS,
                  FilterExpression: "email = :email",
                  ExpressionAttributeValues: { ":email": email },
                })
              );

              if (existingUsers.Items.length > 0) {
                return res.status(400).json({ error: "Email already exists" });
              }

              // å¯†ç¢¼åŠ å¯†
              const salt = await bcryptjs.genSalt(10);
              const hashedPassword = await bcryptjs.hash(password, salt);
              const userId = `USER-${Date.now()}`;

              await db.send(
                new PutCommand({
                  TableName: TABLE_USERS,
                  Item: {
                    id: userId,
                    email,
                    firstName,
                    lastName,
                    password: hashedPassword,
                    createdAt: new Date().toISOString(),
                  },
                })
              );
                        const authtoken = jwt.sign({ userId }, process.env.JWT_SECRET);
              res.json({ authtoken, email });
            } catch (e) {
              console.error(e);
              res.status(500).json({ error: "Internal Server Error" });
            }
          });


          // ğŸ“Œ User Login
          app.post("/api/auth/login", async (req, res) => {
            try {
              const { email, password } = req.body;
          
              // ç”¨ `ScanCommand` æ‰¾ email
              const users = await db.send(
                new ScanCommand({
                  TableName: TABLE_USERS,
                  FilterExpression: "email = :email",
                  ExpressionAttributeValues: { ":email": email },
                })
              );
          
              if (users.Items.length === 0) {
                return res.status(404).json({ error: "User not found" });
              }
          
              const theUser = users.Items[0];
              const match = await bcryptjs.compare(password, theUser.password);
                  if (!match) {
                return res.status(401).json({ error: "Wrong password" });
              }
          
              const authtoken = jwt.sign({ userId: theUser.id }, process.env.JWT_SECRET);
              res.json({ authtoken, userName: theUser.firstName, userEmail: theUser.email });
            } catch (e) {
              console.error(e);
              res.status(500).json({ error: "Internal Server Error" });
            }
          });

          
          // ===============================
          // ğŸ Gift Routes
          // ===============================
          // ğŸ“Œ Get all gifts
          app.get("/api/gifts", async (req, res) => {
            try {
              const data = await db.send(new ScanCommand({ TableName: TABLE_GIFTS }));
              res.json(data.Items || []);
            } catch (error) {
              res.status(500).json({ error: error.message });
            }
          });
          
          // ğŸ“Œ Add new gift
          app.post("/api/gifts", async (req, res) => {
            try {
              const gift = {
                id: `GIFT-${Date.now()}`,
                ...req.body,
                createdAt: new Date().toISOString(),
              };
          
              await db.send(new PutCommand({ TableName: TABLE_GIFTS, Item: gift }));
              res.json({ message: "Gift added!", gift });
            } catch (error) {
              res.status(500).json({ error: error.message });
            }
          });
          
          // ===============================
          // ğŸ” Search Routes
          // ===============================
          app.get("/api/search", async (req, res) => {
            try {
              let filterExpressions = [];
              let expressionAttributeValues = {};
              let expressionAttributeNames = {};
          
              if (req.query.name) {
                filterExpressions.push("contains(#name, :name)");
                expressionAttributeValues[":name"] = req.query.name;
                expressionAttributeNames["#name"] = "name";
              }
          
              if (req.query.category) {
                filterExpressions.push("category = :category");
                expressionAttributeValues[":category"] = req.query.category;
              }
          
              if (req.query.condition) {
                filterExpressions.push("condition = :condition");
                expressionAttributeValues[":condition"] = req.query.condition;
              }
          
              if (req.query.age_years) {
                filterExpressions.push("age_years <= :age");
                expressionAttributeValues[":age"] = parseInt(req.query.age_years);
              }
             
              const params = {
                TableName: TABLE_GIFTS,
                FilterExpression: filterExpressions.length > 0 ? filterExpressions.join(" AND ") : undefined,
                ExpressionAttributeValues: expressionAttributeValues,
                ExpressionAttributeNames: expressionAttributeNames,
              };
          
              const gifts = await db.send(new ScanCommand(params));
              res.json(gifts.Items || []);
            } catch (e) {
              res.status(500).json({ error: e.message });
            }
          });

          
          // ===============================
          // âš ï¸ Error Handling
          // ===============================
          app.use((err, req, res, next) => {
            console.error(err);
            res.status(500).send("Internal Server Error");
          });
          
          app.listen(port, "0.0.0.0", () => {
            console.log(`âœ… Server running on port ${port}`);
            console.log(`âœ… Using AWS DynamoDB Tables: Users: ${TABLE_USERS}, Gifts: ${TABLE_GIFTS}`);
          });

          EOF
          
      - name: âœ… ç¢ºä¿ AWS DynamoDB Table å­˜åœ¨
        run: |
          TABLE_NAME="giftapp-data"
          EXISTING_TABLE=$(aws dynamodb list-tables --query "TableNames" --output json | grep -w "$TABLE_NAME" || echo "")
          if [ -z "$EXISTING_TABLE" ]; then
            echo "ğŸ”„ å‰µå»º DynamoDB Table: $TABLE_NAME"
            aws dynamodb create-table \
              --table-name $TABLE_NAME \
              --attribute-definitions AttributeName=id,AttributeType=S \
              --key-schema AttributeName=id,KeyType=HASH \
              --billing-mode PAY_PER_REQUEST \
              --region ${{ secrets.AWS_REGION }}
            echo "âœ… DynamoDB Table å‰µå»ºæˆåŠŸï¼"
          else
            echo "âœ… DynamoDB Table $TABLE_NAME å·²å­˜åœ¨"
          fi
      - name: ğŸ”„ ç¢ºä¿ç’°å¢ƒè®Šæ•¸è¼‰å…¥
        run: |
          set -a  # è®“ `export` è®Šæ•¸è‡ªå‹•é©ç”¨
          source giftlink-backend/util/import-mongo/.env
          set +a
      - name: ğŸ”„ é€é Node.js `index.js` å°‡ `gifts.json` å­˜å…¥ DynamoDB
        run: |
          node giftlink-backend/util/import-mongo/index.js
      - name: ğŸ” ç™»å½• AWS ECR
        run: |
          aws ecr get-login-password --region ${{ secrets.AWS_REGION }} | \
          docker login --username AWS --password-stdin \
          ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com  
          
      - name: ğŸ—ï¸ å»ºç«‹ Backend Docker Image ä¸¦æ¨é€åˆ° AWS ECR
        run: |
          docker buildx create --use
          docker buildx inspect --bootstrap
          docker buildx build --platform linux/amd64,linux/arm64 \
            -t 253490795451.dkr.ecr.us-east-1.amazonaws.com/giftapp-backend:latest \
            --push ./giftlink-backend
            
      - name: â¹ï¸ æª¢æŸ¥ä¸¦æ›´æ–°æˆ–å‰µå»º giftapp-backend çš„ App Runner æœå‹™
        run: |
          SERVICE_ARN=$(aws apprunner list-services --query "ServiceSummaryList[?ServiceName=='giftapp-backend'].ServiceArn" --output text --region us-east-1)
          if [ -z "$SERVICE_ARN" ] || [ "$SERVICE_ARN" == "None" ]; then
            echo "ğŸš€ `giftapp-backend` æœå‹™ä¸å­˜åœ¨ï¼Œå°‡ç›´æ¥å‰µå»ºæ–°çš„ App Runner æœå‹™..."
          else
            STATUS=$(aws apprunner describe-service --service-arn "$SERVICE_ARN" --query "Service.Status" --output text --region us-east-1)
            
            echo "ğŸ” App Runner ç›®å‰ç‹€æ…‹: $STATUS"
            
            if [ "$STATUS" == "OPERATION_IN_PROGRESS" ]; then
              echo "âš ï¸ `App Runner` æ­£åœ¨é‹è¡Œï¼Œç­‰å¾…å®Œæˆ..."
              while [ "$STATUS" == "OPERATION_IN_PROGRESS" ]; do
                sleep 10
                STATUS=$(aws apprunner describe-service --service-arn "$SERVICE_ARN" --query "Service.Status" --output text --region us-east-1)
              done
            fi
          
            if [ "$STATUS" == "RUNNING" ]; then
              echo "ğŸ”„ æ›´æ–° App Runner æœå‹™..."
              aws apprunner update-service \
                --service-arn "$SERVICE_ARN" \
                --source-configuration "{
                  \"ImageRepository\": {
                    \"ImageIdentifier\": \"253490795451.dkr.ecr.us-east-1.amazonaws.com/giftapp-backend:latest\",
                    \"ImageRepositoryType\": \"ECR\",
                    \"ImageConfiguration\": {
                      \"Port\": \"3060\",
                      \"RuntimeEnvironmentVariables\": {
                        \"DYNAMODB_TABLE\": \"giftapp-data\",
                        \"AWS_REGION\": \"us-east-1\",
                        \"AWS_ACCESS_KEY_ID\": \"${AWS_ACCESS_KEY_ID}\",
                        \"AWS_SECRET_ACCESS_KEY\": \"${AWS_SECRET_ACCESS_KEY}\"
                      }
                    }
                  },
                  \"AuthenticationConfiguration\": {
                    \"AccessRoleArn\": \"arn:aws:iam::253490795451:role/AppRunnerECRAccess\"
                  }
                }" \
                --region us-east-1
              exit 0  # æˆåŠŸæ›´æ–°å¾Œï¼ŒçµæŸè…³æœ¬
            else
              echo "ğŸ›‘ æœå‹™ç‹€æ…‹ç•°å¸¸ ($STATUS)ï¼Œæº–å‚™åˆªé™¤ä¸¦é‡æ–°å‰µå»º..."
              aws apprunner delete-service --service-arn "$SERVICE_ARN" --region us-east-1
              echo "ğŸ•’ ç­‰å¾… App Runner æœå‹™åˆªé™¤å®Œæˆ..."
              sleep 20
            fi
          fi
          
          echo "ğŸš€ å‰µå»ºæ–°çš„ App Runner æœå‹™..."
          aws apprunner create-service \
            --service-name giftapp-backend \
            --source-configuration "{
              \"ImageRepository\": {
                \"ImageIdentifier\": \"253490795451.dkr.ecr.us-east-1.amazonaws.com/giftapp-backend:latest\",
                \"ImageRepositoryType\": \"ECR\",
                \"ImageConfiguration\": {
                  \"Port\": \"3060\",
                  \"RuntimeEnvironmentVariables\": {
                    \"DYNAMODB_TABLE\": \"giftapp-data\",
                    \"AWS_REGION\": \"us-east-1\",
                    \"AWS_ACCESS_KEY_ID\": \"${AWS_ACCESS_KEY_ID}\",
                    \"AWS_SECRET_ACCESS_KEY\": \"${AWS_SECRET_ACCESS_KEY}\"
                  }
                }
              },
              \"AuthenticationConfiguration\": {
                \"AccessRoleArn\": \"arn:aws:iam::253490795451:role/AppRunnerECRAccess\"
              }
            }" \
            --region us-east-1

          
      - name: ğŸ”§ æ›´æ–° giftlink-frontend/src/config.js
        run: |
          BACKEND_URL=$(aws apprunner list-services --query "ServiceSummaryList[?ServiceName=='giftapp-backend'].ServiceUrl" --output text --region ${{ secrets.AWS_REGION }})

          if [ -z "$BACKEND_URL" ] || [ "$BACKEND_URL" == "None" ]; then
              echo "âŒ ç„¡æ³•å–å¾— Backend URLï¼Œéƒ¨ç½²ä¸­æ­¢"
              exit 1
          fi

          # **ç¢ºä¿ `backendUrl` ä½¿ç”¨ HTTPS**
          BACKEND_URL="https://$BACKEND_URL"
          echo "ğŸ” å–å¾—çš„ Backend URL: $BACKEND_URL"
          echo "REACT_APP_BACKEND_URL=$BACKEND_URL" > giftlink-frontend/.env
          cat giftlink-frontend/.env  # ç¢ºä¿å…§å®¹æ›´æ–°

          cat <<EOF > giftlink-frontend/src/config.js
          const config = {
            backendUrl: "$BACKEND_URL",
          };
          console.log("ğŸ” backendUrl in config.js:", config.backendUrl);
          export { config as urlConfig };
          EOF
          cat giftlink-frontend/src/config.js  # ç¢ºä¿å…§å®¹æ­£ç¢º

          echo "âœ… Backend URL: $BACKEND_URL"
          echo "BACKEND_URL=$BACKEND_URL" >> $GITHUB_ENV


      - name: ğŸ“¦ å®‰è£ Express å’Œ CORS in giftwebsite
        run: |
          cd ./giftwebsite
          npm install express cors http-proxy-middleware
          cd ..
          
      - name: ğŸ” æŸ¥çœ‹ .env æª”æ¡ˆå…§å®¹ (å®Œæ•´é¡¯ç¤º)
        run: |
          cd ./giftlink-frontend
          npm install
          npm run build
          cd ..
          
      - name: ğŸ› ï¸ å»ºç«‹ `giftwebsite/server.js`
        run: |
          cat <<EOF > giftwebsite/server.js
          const express = require("express");
          const path = require("path");
          const { createProxyMiddleware } = require("http-proxy-middleware");

          const app = express();
          const PORT = 9000;
          const BACKEND_URL = process.env.BACKEND_URL;

          if (!BACKEND_URL.startsWith("https://")) {
            console.warn("âš ï¸ BACKEND_URL ä¸æ˜¯ HTTPSï¼Œå¯èƒ½å°è‡´ Mixed Content å•é¡Œ");
          }

          // ä»£ç† API è«‹æ±‚åˆ° `giftlink-backend`
          app.use("/api", createProxyMiddleware({
            target: BACKEND_URL,
            changeOrigin: true,
            secure: true, // å¼·åˆ¶ HTTPS
          }));

          // æä¾› React éœæ…‹æª”æ¡ˆ
          app.use(express.static(path.join(__dirname, "build")));

          // è®“ React è™•ç†æ‰€æœ‰è·¯ç”±
          app.get("*", function (req, res) {
            res.sendFile(path.join(__dirname, "build", "index.html"));
          });

          // å•Ÿå‹•ä¼ºæœå™¨
          app.listen(PORT, () => {
            console.log(\`âœ… giftwebsite running on port \${PORT}\`);
            console.log(\`âœ… Proxying API requests to: \${BACKEND_URL}\`);
          });
          EOF



      - name: ğŸ› ï¸ å»ºç«‹ `giftwebsite/Dockerfile`
        run: |
          cat <<EOF > giftwebsite/Dockerfile
          # 1ï¸âƒ£ å»ºç½® React å‰ç«¯
          FROM node:18-alpine AS build
          WORKDIR /usr/src/app
          COPY package.json package-lock.json ./
          RUN npm install --production
          COPY . .
          
          # 2ï¸âƒ£ é‹è¡Œ Express ä¼ºæœå™¨ï¼Œä»£ç† API
          FROM node:18-alpine
          WORKDIR /app
          
          # è¤‡è£½å¿…è¦æª”æ¡ˆ
          COPY --from=build /usr/src/app/package.json .
          COPY --from=build /usr/src/app/node_modules ./node_modules
          COPY --from=build /usr/src/app/build ./build
          COPY --from=build /usr/src/app/server.js .
          
          # è¨­å®šç’°å¢ƒè®Šæ•¸
          ARG BACKEND_URL
          ENV BACKEND_URL=${BACKEND_URL}
          ENV PORT=9000
          
          # é–‹æ”¾æ‡‰ç”¨ç«¯å£
          EXPOSE 9000
          
          # å•Ÿå‹•æ‡‰ç”¨
          CMD ["node", "server.js"]
          EOF

      - name: ğŸ—ï¸ å»ºç«‹ `giftwebsite` Docker Image ä¸¦æ¨é€åˆ° AWS ECR
        run: |
          docker buildx create --use
          docker buildx inspect --bootstrap
          docker buildx build --platform linux/amd64,linux/arm64 \
            -t 253490795451.dkr.ecr.us-east-1.amazonaws.com/giftwebsite:latest \
            --build-arg BACKEND_URL=${{ env.BACKEND_URL }} \
            --push ./giftwebsite

      - name: ğŸš€ éƒ¨ç½² `giftwebsite` åˆ° AWS App Runner
        run: |
          SERVICE_ARN=$(aws apprunner list-services --query "ServiceSummaryList[?ServiceName=='giftwebsite'].ServiceArn" --output text --region ${{ secrets.AWS_REGION }})

          if [ "$SERVICE_ARN" == "None" ] || [ -z "$SERVICE_ARN" ]; then
              echo "ğŸ”„ å‰µå»º App Runner æœå‹™..."
              aws apprunner create-service \
                --service-name giftwebsite \
                --source-configuration "{
                  \"ImageRepository\": {
                    \"ImageIdentifier\": \"253490795451.dkr.ecr.us-east-1.amazonaws.com/giftwebsite:latest\",
                    \"ImageRepositoryType\": \"ECR\",
                    \"ImageConfiguration\": {
                      \"Port\": \"9000\",
                      \"RuntimeEnvironmentVariables\": {
                        \"BACKEND_URL\": \"${{ env.BACKEND_URL }}\"
                      }
                    }
                  },
                  \"AuthenticationConfiguration\": {
                    \"AccessRoleArn\": \"arn:aws:iam::253490795451:role/AppRunnerECRAccess\"
                  }
                }" \
                --region ${{ secrets.AWS_REGION }}
          else
              echo "ğŸ”„ æ›´æ–° App Runner æœå‹™..."
              aws apprunner update-service \
                --service-arn "$SERVICE_ARN" \
                --source-configuration "{
                  \"ImageRepository\": {
                    \"ImageIdentifier\": \"253490795451.dkr.ecr.us-east-1.amazonaws.com/giftwebsite:latest\",
                    \"ImageRepositoryType\": \"ECR\",
                    \"ImageConfiguration\": {
                      \"Port\": \"9000\",
                      \"RuntimeEnvironmentVariables\": {
                        \"BACKEND_URL\": \"${{ env.BACKEND_URL }}\"
                      }
                    }
                  },
                  \"AuthenticationConfiguration\": {
                    \"AccessRoleArn\": \"arn:aws:iam::253490795451:role/AppRunnerECRAccess\"
                  }
                }" \
                --region ${{ secrets.AWS_REGION }}
          fi


      - name: ğŸ” ç²å– `giftwebsite` éƒ¨ç½²ç¶²å€
        run: |
          export REGION=${{ secrets.AWS_REGION }}
          GIFTWEBSITE_URL=$(aws apprunner list-services --query "ServiceSummaryList[?ServiceName=='giftwebsite'].ServiceUrl" --output text --region $REGION)

          if [ -z "$GIFTWEBSITE_URL" ] || [ "$GIFTWEBSITE_URL" == "None" ]; then
              echo "âŒ ç„¡æ³•å–å¾— GIFTWEBSITE_URLï¼Œéƒ¨ç½²ä¸­æ­¢"
              exit 1
          fi

          echo "âœ… GIFTWEBSITE_URL: https://$GIFTWEBSITE_URL"
          echo "GIFTWEBSITE_URL=https://$GIFTWEBSITE_URL" >> $GITHUB_ENV
