name: Completely Deploy to AWS Serverless

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸš€ æª¢å‡ºç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: ğŸ” è¨­å®š AWS CLI
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: ğŸ³ ç™»å…¥ AWS ECR
        run: |
          aws ecr get-login-password --region ${{ secrets.AWS_REGION }} | \
          docker login --username AWS --password-stdin ${{ secrets.ECR_REPO }}

      # âœ… 2ï¸âƒ£ ç¢ºä¿ AWS DynamoDB Table å­˜åœ¨
      - name: ğŸ” æª¢æŸ¥æˆ–å»ºç«‹ DynamoDB Table
        run: |
          TABLE_NAME="giftapp-data"
          TABLE_EXISTS=$(aws dynamodb list-tables --query "TableNames" --output json | jq -r --arg TABLE_NAME "$TABLE_NAME" 'contains([$TABLE_NAME])')

          if [ "$TABLE_EXISTS" != "true" ]; then
            echo "ğŸš€ å‰µå»º DynamoDB Table: $TABLE_NAME..."
            aws dynamodb create-table \
              --table-name $TABLE_NAME \
              --attribute-definitions AttributeName=id,AttributeType=S \
              --key-schema AttributeName=id,KeyType=HASH \
              --provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
              --region ${{ secrets.AWS_REGION }}
            echo "âœ… DynamoDB Table å‰µå»ºæˆåŠŸï¼"
          else
            echo "âœ… DynamoDB Table å·²å­˜åœ¨ï¼Œè·³éå‰µå»º"
          fi

      - name: ğŸ—ï¸ å»ºç«‹ Backend Docker Image ä¸¦æ¨é€åˆ° AWS ECR
        run: |
          docker buildx create --use
          docker buildx inspect --bootstrap
          docker buildx build --platform linux/amd64 \
            -t ${{ secrets.ECR_REPO }}/giftapp-backend:latest --push ./giftlink-backend

      - name: ğŸ—ï¸ å»ºç«‹ Frontend Docker Image ä¸¦æ¨é€åˆ° AWS ECR
        run: |
          docker buildx create --use
          docker buildx inspect --bootstrap
          docker buildx build --platform linux/amd64 \
            -t ${{ secrets.ECR_REPO }}/giftwebsite:latest --push ./giftwebsite

      - name: ğŸš€ éƒ¨ç½² Backend åˆ° AWS App Runner
        run: |
          BACKEND_ARN=$(aws apprunner list-services --query "ServiceSummaryList[?ServiceName=='giftapp-backend'].ServiceArn" --output text --region ${{ secrets.AWS_REGION }})

          if [ -z "$BACKEND_ARN" ]; then
            echo "ğŸ”„ å‰µå»º Backend App Runner æœå‹™..."
            aws apprunner create-service \
              --service-name giftapp-backend \
              --source-configuration '{
                "ImageRepository": {
                  "ImageIdentifier": "${{ secrets.ECR_REPO }}/giftapp-backend:latest",
                  "ImageRepositoryType": "ECR",
                  "ImageConfiguration": {
                    "Port": "3060"
                  }
                },
                "AuthenticationConfiguration": {
                  "AccessRoleArn": "arn:aws:iam::253490795451:role/AppRunnerECRAccess"
                }
              }' \
              --region ${{ secrets.AWS_REGION }} \
              --instance-configuration '{
                "EnvironmentVariables": [
                  {"Name": "DATABASE_TYPE", "Value": "DYNAMODB"},
                  {"Name": "DYNAMODB_TABLE", "Value": "giftapp-data"},
                  {"Name": "JWT_SECRET", "Value": "mysecret"}
                ]
              }'
          else
            echo "ğŸ”„ æ›´æ–° Backend App Runner æœå‹™..."
            aws apprunner update-service \
              --service-arn "$BACKEND_ARN" \
              --source-configuration '{
                "ImageRepository": {
                  "ImageIdentifier": "${{ secrets.ECR_REPO }}/giftapp-backend:latest",
                  "ImageRepositoryType": "ECR",
                  "ImageConfiguration": {
                    "Port": "3060"
                  }
                },
                "AuthenticationConfiguration": {
                  "AccessRoleArn": "arn:aws:iam::253490795451:role/AppRunnerECRAccess"
                }
              }' \
              --region ${{ secrets.AWS_REGION }} \
              --instance-configuration '{
                "EnvironmentVariables": [
                  {"Name": "DATABASE_TYPE", "Value": "DYNAMODB"},
                  {"Name": "DYNAMODB_TABLE", "Value": "giftapp-data"},
                  {"Name": "JWT_SECRET", "Value": "mysecret"}
                ]
              }'
          fi

      - name: ğŸš€ éƒ¨ç½² Frontend åˆ° AWS App Runner
        run: |
          FRONTEND_ARN=$(aws apprunner list-services --query "ServiceSummaryList[?ServiceName=='giftwebsite'].ServiceArn" --output text --region ${{ secrets.AWS_REGION }})

          if [ -z "$FRONTEND_ARN" ]; then
            echo "ğŸ”„ å‰µå»º Frontend App Runner æœå‹™..."
            aws apprunner create-service \
              --service-name giftwebsite \
              --source-configuration '{
                "ImageRepository": {
                  "ImageIdentifier": "${{ secrets.ECR_REPO }}/giftwebsite:latest",
                  "ImageRepositoryType": "ECR",
                  "ImageConfiguration": {
                    "Port": "9000"
                  }
                },
                "AuthenticationConfiguration": {
                  "AccessRoleArn": "arn:aws:iam::253490795451:role/AppRunnerECRAccess"
                }
              }' \
              --region ${{ secrets.AWS_REGION }}
          else
            echo "ğŸ”„ æ›´æ–° Frontend App Runner æœå‹™..."
            aws apprunner update-service \
              --service-arn "$FRONTEND_ARN" \
              --source-configuration '{
                "ImageRepository": {
                  "ImageIdentifier": "${{ secrets.ECR_REPO }}/giftwebsite:latest",
                  "ImageRepositoryType": "ECR",
                  "ImageConfiguration": {
                    "Port": "9000"
                  }
                },
                "AuthenticationConfiguration": {
                  "AccessRoleArn": "arn:aws:iam::253490795451:role/AppRunnerECRAccess"
                }
              }' \
              --region ${{ secrets.AWS_REGION }}
          fi

      - name: å–å¾—æ‡‰ç”¨ç¨‹å¼ç¶²å€
        run: |
          BACKEND_URL=$(aws apprunner list-services --query "ServiceSummaryList[?ServiceName=='giftapp-backend'].ServiceUrl" --output text --region ${{ secrets.AWS_REGION }})
          FRONTEND_URL=$(aws apprunner list-services --query "ServiceSummaryList[?ServiceName=='giftwebsite'].ServiceUrl" --output text --region ${{ secrets.AWS_REGION }})

          echo "âœ… Backend URL: $BACKEND_URL"
          echo "âœ… Frontend URL: $FRONTEND_URL"
          echo "BACKEND_URL=$BACKEND_URL" >> $GITHUB_ENV
          echo "FRONTEND_URL=$FRONTEND_URL" >> $GITHUB_ENV

      - name: ğŸ“ æ›´æ–° README.md é¡¯ç¤ºç¶²ç«™ç¶²å€
        run: |
          echo "# ğŸ GiftWebsite" > README.md
          echo "" >> README.md
          echo "âœ… ä½ çš„ç¶²ç«™å·²éƒ¨ç½² ğŸ‰" >> README.md
          echo "" >> README.md
          echo 'ğŸ”— <a href="https://'$FRONTEND_URL'" target="_blank">**è¨ªå• GiftWebsite**</a>' >> README.md
          echo "" >> README.md
          echo "ğŸš€ æ¯æ¬¡ Push åˆ° main éƒ½æœƒè‡ªå‹•éƒ¨ç½²åˆ° AWS App Runnerï¼" >> README.md
          
          git config --global user.name 'github-actions'
          git config --global user.email 'github-actions@github.com'
          git add README.md
          git commit -m "æ›´æ–° README.mdï¼Œé¡¯ç¤ºæœ€æ–°çš„éƒ¨ç½²ç¶²å€"
          git push
