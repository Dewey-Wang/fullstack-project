name: Completely Deploy to AWS Serverless

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸš€ æª¢å‡ºç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: ğŸ” è¨­å®š AWS CLI
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # **ğŸ”´ ç¡®ä¿ `App Runner` ä¸ä¼šå¡ä½**
      - name: â¹ï¸ åœæ­¢å·²æœ‰çš„ App Runner æœå‹™ (é¿å… OPERATION_IN_PROGRESS)
        run: |
          SERVICE_ARN=$(aws apprunner list-services --query "ServiceSummaryList[?ServiceName=='giftapp-backend'].ServiceArn" --output text --region ${{ secrets.AWS_REGION }})
          
          if [ ! -z "$SERVICE_ARN" ]; then
            STATUS=$(aws apprunner describe-service --service-arn "$SERVICE_ARN" --query "Service.Status" --output text --region ${{ secrets.AWS_REGION }})
            
            if [ "$STATUS" == "OPERATION_IN_PROGRESS" ]; then
              echo "âš ï¸ `App Runner` æ­£åœ¨é‹è¡Œï¼Œç­‰å¾…å®Œæˆ..."
              while [ "$STATUS" == "OPERATION_IN_PROGRESS" ]; do
                STATUS=$(aws apprunner describe-service --service-arn "$SERVICE_ARN" --query "Service.Status" --output text --region ${{ secrets.AWS_REGION }})
              done
            fi
            
            if [ "$STATUS" != "DELETED" ]; then
              echo "ğŸ›‘ åœæ­¢ App Runner æœå‹™..."
              aws apprunner delete-service --service-arn "$SERVICE_ARN" --region ${{ secrets.AWS_REGION }}
            fi
          fi

      - name: ğŸ“¦ å®‰è£ AWS SDK v3 & dotenv
        run: |
          cd giftlink-backend
          npm uninstall aws-sdk
          npm install @aws-sdk/client-dynamodb @aws-sdk/lib-dynamodb dotenv
          cd ..
     
      - name: ğŸ”§ æ›´æ–° `.env`ï¼Œç§»é™¤ MongoDB ä¸¦æ·»åŠ  DynamoDB
        run: |
          cat <<EOF > giftlink-backend/.env
          DYNAMODB_TABLE=giftapp-data
          AWS_REGION=${{ secrets.AWS_REGION }}
          JWT_SECRET=mysecret
          EOF
          
      - name: ğŸ”§ æ›´æ–° `Dockerfile`
        run: |
          cat <<EOF > giftlink-backend/Dockerfile
          FROM node:18.12.1-bullseye-slim

          WORKDIR /usr/src/app

          COPY package*.json ./

          RUN npm install

          COPY . .

          # ç¢ºä¿ç›®éŒ„å­˜åœ¨
          RUN mkdir -p /usr/src/app/util/import-mongo
          
          # **COPY gifts.json**
          COPY util/import-mongo/gifts.json /usr/src/app/util/import-mongo/gifts.json
          
          # ç¢ºä¿è¤‡è£½æˆåŠŸ
          RUN ls -al /usr/src/app/util/import-mongo/

          EXPOSE 3060

          CMD ["node", "app.js"]
          EOF
      
      - name: ğŸ“‚ ç¢ºèª GitHub Actions å…§éƒ¨è·¯å¾‘
        run: |
          pwd
          ls -al
          ls -al giftlink-backend/util/import-mongo/

      - name: ğŸ”§ ä¿®æ­£ `db.js` è®€å– `gifts.json`
        run: |
          ls -al giftlink-backend/util/import-mongo/
          cat giftlink-backend/util/import-mongo/gifts.json
      - name: ğŸ”§ ä¿®æ­£ `db.js`ï¼Œé¿å… Shell è§£æéŒ¯èª¤
        run: |
          echo 'require("dotenv").config();' > giftlink-backend/models/db.js
          echo 'const fs = require("fs");' >> giftlink-backend/models/db.js
          echo 'const path = require("path");' >> giftlink-backend/models/db.js
          echo 'console.log("ğŸ” å˜—è©¦è®€å– gifts.json");' >> giftlink-backend/models/db.js
          echo 'const giftsFilePath = path.join(__dirname, "..", "util", "import-mongo", "gifts.json");' >> giftlink-backend/models/db.js
          echo 'if (!fs.existsSync(giftsFilePath)) {' >> giftlink-backend/models/db.js
          echo '  console.error("âŒ æ‰¾ä¸åˆ° gifts.json: " + giftsFilePath);' >> giftlink-backend/models/db.js
          echo '  process.exit(1);' >> giftlink-backend/models/db.js
          echo '}' >> giftlink-backend/models/db.js
      
      - name: ğŸ›  ç¢ºä¿ `db.js` æ˜¯ JS è€Œä¸æ˜¯ Shell è…³æœ¬
        run: file giftlink-backend/models/db.js
      
      - name: ğŸ›  ç¢ºä¿ `db.js` å¯«å…¥æ­£ç¢º
        run: cat giftlink-backend/models/db.js





     
      - name: ğŸ”§ æ›´æ–° `app.js` ä¾†æ”¯æ´ DynamoDB
        run: |
          cat <<EOF > giftlink-backend/app.js
          const express = require("express");
          const cors = require("cors");
          const db = require("./models/db");

          const app = express();
          app.use("*", cors());
          app.use(express.json());

          const port = process.env.PORT || 3060;

          // ç¢ºä¿ API æ­£å¸¸é‹è¡Œ
          app.get("/", (req, res) => {
            res.send("Inside the server - Now using DynamoDB!");
          });

          // ç¢ºä¿å¯ä»¥è®€å–èˆ‡å¯«å…¥ DynamoDB
          app.get("/api/gifts", async (req, res) => {
            try {
              const gifts = await db.getGifts();
              res.json(gifts);
            } catch (error) {
              res.status(500).json({ error: error.message });
            }
          });

          app.post("/api/gifts", async (req, res) => {
            try {
              const newGift = req.body;
              await db.addGift(newGift);
              res.json({ message: "Gift added!", gift: newGift });
            } catch (error) {
              res.status(500).json({ error: error.message });
            }
          });

          app.listen(port, "0.0.0.0", () => {
            console.log("âœ… Server running on port", port);
            console.log("âœ… Using AWS DynamoDB Table:", process.env.DYNAMODB_TABLE);
          });
          EOF
