name: Completely Deploy to AWS Serverless

on:
  push:
    branches:
      - main  # ç›£è½ `main` åˆ†æ”¯çš„è®Šæ›´

permissions:
  contents: write  # âœ… ç¢ºä¿ç¸®æ’æ­£ç¢º

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸš€ æª¢å‡ºç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: ğŸ” è¨­å®š AWS CLI
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: ğŸ”§ ç¢ºä¿ `.env` è¨­ç½® `DYNAMODB_TABLE`
        run: |
          cat <<EOF > giftlink-backend/.env
          DYNAMODB_TABLE=giftapp-data
          JWT_SECRET=mysecret
          EOF

      - name: ğŸ”„ ç¢ºä¿ç’°å¢ƒè®Šæ•¸è¼‰å…¥
        run: |
          set -a  # è®“ `export` è®Šæ•¸è‡ªå‹•é©ç”¨
          source giftlink-backend/.env
          set +a

      - name: ğŸ”„ é€é Node.js `index.js` å°‡ `gifts.json` å­˜å…¥ DynamoDB
        run: |
          node giftlink-backend/util/import-mongo/index.js

      - name: ğŸ” ç™»å…¥ AWS ECR
        run: |
          aws ecr get-login-password --region ${{ secrets.AWS_REGION }} | \
          docker login --username AWS --password-stdin \
          ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com  

      - name: ğŸ—ï¸ å»ºç«‹ Backend Docker Image ä¸¦æ¨é€åˆ° AWS ECR
        run: |
          docker buildx create --use
          docker buildx inspect --bootstrap
          docker buildx build --platform linux/amd64,linux/arm64 \
            -t ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/giftapp-backend:latest \
            --push ./giftlink-backend

      - name: ğŸš€ éƒ¨ç½² Backend åˆ° AWS App Runner
        run: |
          SERVICE_ARN=$(aws apprunner list-services --query "ServiceSummaryList[?ServiceName=='giftapp-backend'].ServiceArn" --output text --region ${{ secrets.AWS_REGION }})
          echo "ğŸ” å–å¾—çš„ SERVICE_ARN: $SERVICE_ARN"

          if [ "$SERVICE_ARN" == "None" ] || [ -z "$SERVICE_ARN" ]; then
              echo "ğŸ”„ å‰µå»º App Runner æœå‹™..."
              aws apprunner create-service \
                --service-name giftapp-backend \
                --source-configuration "{
                  \"ImageRepository\": {
                    \"ImageIdentifier\": \"${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/giftapp-backend:latest\",
                    \"ImageRepositoryType\": \"ECR\",
                    \"ImageConfiguration\": {
                      \"Port\": \"3060\"
                    }
                  },
                  \"AuthenticationConfiguration\": {
                    \"AccessRoleArn\": \"arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/AppRunnerECRAccess\"
                  }
                }" \
                --region ${{ secrets.AWS_REGION }}
          else
              echo "ğŸ”„ æ›´æ–° App Runner æœå‹™..."
              aws apprunner update-service \
                --service-arn "$SERVICE_ARN" \
                --source-configuration "{
                  \"ImageRepository\": {
                    \"ImageIdentifier\": \"${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/giftapp-backend:latest\",
                    \"ImageRepositoryType\": \"ECR\",
                    \"ImageConfiguration\": {
                      \"Port\": \"3060\"
                    }
                  },
                  \"AuthenticationConfiguration\": {
                    \"AccessRoleArn\": \"arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/AppRunnerECRAccess\"
                  }
                }" \
                --region ${{ secrets.AWS_REGION }}
          fi

      - name: ğŸ”§ æ›´æ–° `giftlink-frontend/src/config.js`
        run: |
          BACKEND_URL=$(aws apprunner list-services --query "ServiceSummaryList[?ServiceName=='giftapp-backend'].ServiceUrl" --output text --region ${{ secrets.AWS_REGION }})
          
          if [ -z "$BACKEND_URL" ] || [ "$BACKEND_URL" == "None" ]; then
              echo "âŒ ç„¡æ³•å–å¾— Backend URLï¼Œéƒ¨ç½²ä¸­æ­¢"
              exit 1
          fi
          echo "ğŸ” å–å¾—çš„ Backend URL: https://$BACKEND_URL/"
          echo "REACT_APP_BACKEND_URL=https://$BACKEND_URL/" > giftlink-frontend/.env
          cat giftlink-frontend/.env  # ç¢ºä¿å…§å®¹æ›´æ–°
          
          cat <<EOF > giftlink-frontend/src/config.js
          const config = {
            backendUrl: "https://$BACKEND_URL/",
          };
          console.log("ğŸ” backendUrl in config.js:", config.backendUrl);
          export { config as urlConfig };
          EOF
          cat giftlink-frontend/src/config.js  # ç¢ºä¿å…§å®¹æ­£ç¢º

      - name: ğŸ” æŸ¥çœ‹ `.env` æª”æ¡ˆå…§å®¹ (å®Œæ•´é¡¯ç¤º)
        run: |
          cd giftlink-frontend
          npm install
          npm run build
          cd ..

      - name: ğŸ“ ç”Ÿæˆ `giftlink-frontend` çš„ Dockerfile
        run: |
          cat <<EOF > giftlink-frontend/Dockerfile
          # 1. ä½¿ç”¨ Node.js å»ºç«‹ React å‰ç«¯æ‡‰ç”¨
          FROM node:18-alpine AS build
          WORKDIR /app
          COPY package.json package-lock.json ./
          RUN npm install
          COPY . .
          RUN npm run build

          # 2. ä½¿ç”¨ Nginx ä½œç‚ºéœæ…‹ç¶²ç«™ä¼ºæœå™¨
          FROM nginx:alpine
          WORKDIR /usr/share/nginx/html
          RUN rm -rf ./*
          COPY --from=build /app/build .
          EXPOSE 80
          CMD ["nginx", "-g", "daemon off;"]
          EOF

          echo "âœ… Dockerfile å·²æˆåŠŸå»ºç«‹ï¼"
          cat giftlink-frontend/Dockerfile
          
      - name: ğŸ—ï¸ å»ºç«‹ giftlink-frontend Docker Image ä¸¦æ¨é€åˆ° AWS ECR
        run: |
          docker buildx create --use
          docker buildx inspect --bootstrap
          docker buildx build --platform linux/amd64,linux/arm64 \
            -t 253490795451.dkr.ecr.us-east-1.amazonaws.com/giftlink-frontend:latest \
            --push ./giftlink-frontend
            
      - name: ğŸš€ éƒ¨ç½² giftlink-frontend åˆ° AWS App Runner
        run: |
          SERVICE_ARN=$(aws apprunner list-services --query "ServiceSummaryList[?ServiceName=='giftlink-frontend'].ServiceArn" --output text --region ${{ secrets.AWS_REGION }})
          echo "ğŸ” å–å¾—çš„ SERVICE_ARN: $SERVICE_ARN"

          if [ "$SERVICE_ARN" == "None" ] || [ -z "$SERVICE_ARN" ]; then
              echo "ğŸ”„ å‰µå»º App Runner æœå‹™..."
              aws apprunner create-service \
                --service-name giftlink-frontend \
                --source-configuration "{
                  \"ImageRepository\": {
                    \"ImageIdentifier\": \"253490795451.dkr.ecr.us-east-1.amazonaws.com/giftlink-frontend:latest\",
                    \"ImageRepositoryType\": \"ECR\",
                    \"ImageConfiguration\": {
                      \"Port\": \"80\"
                    }
                  },
                  \"AuthenticationConfiguration\": {
                    \"AccessRoleArn\": \"arn:aws:iam::253490795451:role/AppRunnerECRAccess\"
                  }
                }" \
                --region ${{ secrets.AWS_REGION }}
          else
              echo "ğŸ”„ æ›´æ–° App Runner æœå‹™..."
              aws apprunner update-service \
                --service-arn "$SERVICE_ARN" \
                --source-configuration "{
                  \"ImageRepository\": {
                    \"ImageIdentifier\": \"253490795451.dkr.ecr.us-east-1.amazonaws.com/giftlink-frontend:latest\",
                    \"ImageRepositoryType\": \"ECR\",
                    \"ImageConfiguration\": {
                      \"Port\": \"80\"
                    }
                  },
                  \"AuthenticationConfiguration\": {
                    \"AccessRoleArn\": \"arn:aws:iam::253490795451:role/AppRunnerECRAccess\"
                  }
                }" \
                --region ${{ secrets.AWS_REGION }}
          fi


      - name: ğŸ“¦ å®‰è£express and cors in giftwebsite
        run: |
          cd ./giftwebsite
          npm install express cors
          cd ..
          

     - name: ğŸ› ï¸ å»ºç«‹ `giftwebsite/Dockerfile`
        run: |
          cat <<EOF > giftwebsite/Dockerfile
          # 1ï¸âƒ£ å»ºç½® React å‰ç«¯
          FROM node:18-alpine AS build
          WORKDIR /app
          COPY package.json package-lock.json ./
          RUN npm install
          COPY . .
          RUN npm run build

          # 2ï¸âƒ£ é‹è¡Œ Express ä¼ºæœå™¨
          FROM node:18-alpine
          WORKDIR /app
          COPY --from=build /app/package.json .
          COPY --from=build /app/node_modules ./node_modules
          COPY --from=build /app/build ./build
          COPY --from=build /app/server.js .
          ENV PORT=9000
          EXPOSE 9000
          CMD ["node", "server.js"]
          EOF

      - name: ğŸ› ï¸ å»ºç«‹ `giftwebsite/server.js`
        run: |
          cat <<EOF > giftwebsite/server.js
          const express = require("express");
          const path = require("path");
          const cors = require("cors");

          const app = express();
          const PORT = process.env.PORT || 9000;

          // å•Ÿç”¨ CORS
          app.use(cors());

          // æä¾› React éœæ…‹æª”æ¡ˆ
          app.use(express.static(path.join(__dirname, "build")));

          // è®“ React è™•ç†æ‰€æœ‰è·¯ç”±
          app.get("*", (req, res) => {
            res.sendFile(path.join(__dirname, "build", "index.html"));
          });

          // å•Ÿå‹•ä¼ºæœå™¨
          app.listen(PORT, () => {
            console.log(\`âœ… giftwebsite running on port \${PORT}\`);
          });
          EOF

      - name: ğŸ—ï¸ å»ºç«‹ `giftwebsite` Docker Image ä¸¦æ¨é€åˆ° AWS ECR
        run: |
          docker buildx create --use
          docker buildx inspect --bootstrap
          docker buildx build --platform linux/amd64,linux/arm64 \
            -t 253490795451.dkr.ecr.us-east-1.amazonaws.com/giftwebsite:latest \
            --push ./giftwebsite

      - name: ğŸš€ éƒ¨ç½² `giftwebsite` åˆ° AWS App Runner
        run: |
          SERVICE_ARN=$(aws apprunner list-services --query "ServiceSummaryList[?ServiceName=='giftwebsite'].ServiceArn" --output text --region ${{ secrets.AWS_REGION }})
          echo "ğŸ” å–å¾—çš„ SERVICE_ARN: $SERVICE_ARN"

          if [ "$SERVICE_ARN" == "None" ] || [ -z "$SERVICE_ARN" ]; then
              echo "ğŸ”„ å‰µå»º App Runner æœå‹™..."
              aws apprunner create-service \
                --service-name giftwebsite \
                --source-configuration "{
                  \"ImageRepository\": {
                    \"ImageIdentifier\": \"253490795451.dkr.ecr.us-east-1.amazonaws.com/giftwebsite:latest\",
                    \"ImageRepositoryType\": \"ECR\",
                    \"ImageConfiguration\": {
                      \"Port\": \"9000\"
                    }
                  },
                  \"AuthenticationConfiguration\": {
                    \"AccessRoleArn\": \"arn:aws:iam::253490795451:role/AppRunnerECRAccess\"
                  }
                }" \
                --region ${{ secrets.AWS_REGION }}
          else
              echo "ğŸ”„ æ›´æ–° App Runner æœå‹™..."
              aws apprunner update-service \
                --service-arn "$SERVICE_ARN" \
                --source-configuration "{
                  \"ImageRepository\": {
                    \"ImageIdentifier\": \"253490795451.dkr.ecr.us-east-1.amazonaws.com/giftwebsite:latest\",
                    \"ImageRepositoryType\": \"ECR\",
                    \"ImageConfiguration\": {
                      \"Port\": \"9000\"
                    }
                  },
                  \"AuthenticationConfiguration\": {
                    \"AccessRoleArn\": \"arn:aws:iam::253490795451:role/AppRunnerECRAccess\"
                  }
                }" \
                --region ${{ secrets.AWS_REGION }}
          fi

      - name: ğŸ” ç²å– `giftwebsite` éƒ¨ç½²ç¶²å€
        run: |
          export REGION=${{ secrets.AWS_REGION }}
          GIFTWEBSITE_URL=$(aws apprunner list-services --query "ServiceSummaryList[?ServiceName=='giftwebsite'].ServiceUrl" --output text --region $REGION)

          if [ -z "$GIFTWEBSITE_URL" ] || [ "$GIFTWEBSITE_URL" == "None" ]; then
              echo "âŒ ç„¡æ³•å–å¾— GIFTWEBSITE_URLï¼Œéƒ¨ç½²ä¸­æ­¢"
              exit 1
          fi

          echo "âœ… GIFTWEBSITE_URL: https://$GIFTWEBSITE_URL"
          echo "GIFTWEBSITE_URL=https://$GIFTWEBSITE_URL" >> $GITHUB_ENV
