name: Completely Deploy to AWS Serverless

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸš€ æª¢å‡ºç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: ğŸ” è¨­å®š AWS CLI
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # **ğŸ”´ ç¡®ä¿ `App Runner` ä¸ä¼šå¡ä½**
      - name: â¹ï¸ åœæ­¢å·²æœ‰çš„ App Runner æœå‹™ (é¿å… OPERATION_IN_PROGRESS)
        run: |
          SERVICE_ARN=$(aws apprunner list-services --query "ServiceSummaryList[?ServiceName=='giftapp-backend'].ServiceArn" --output text --region ${{ secrets.AWS_REGION }})
          
          if [ ! -z "$SERVICE_ARN" ]; then
            STATUS=$(aws apprunner describe-service --service-arn "$SERVICE_ARN" --query "Service.Status" --output text --region ${{ secrets.AWS_REGION }})
            
            if [ "$STATUS" == "OPERATION_IN_PROGRESS" ]; then
              echo "âš ï¸ `App Runner` æ­£åœ¨é‹è¡Œï¼Œç­‰å¾…å®Œæˆ..."
              while [ "$STATUS" == "OPERATION_IN_PROGRESS" ]; do
                STATUS=$(aws apprunner describe-service --service-arn "$SERVICE_ARN" --query "Service.Status" --output text --region ${{ secrets.AWS_REGION }})
              done
            fi
            
            if [ "$STATUS" != "DELETED" ]; then
              echo "ğŸ›‘ åœæ­¢ App Runner æœå‹™..."
              aws apprunner delete-service --service-arn "$SERVICE_ARN" --region ${{ secrets.AWS_REGION }}
            fi
          fi

      - name: ğŸ“¦ å®‰è£ AWS SDK v3 & dotenv
        run: |
          cd giftlink-backend
          npm uninstall aws-sdk
          npm install @aws-sdk/client-dynamodb @aws-sdk/lib-dynamodb dotenv
          cd ..
      - name: ğŸ—‘ï¸ ç§»é™¤ `util/import-mongo/.env`
        run: rm -f giftlink-backend/util/import-mongo/.env
      - name: ğŸ—‘ï¸ ç§»é™¤ `util/import-mongo/index.js`
        run: rm -f giftlink-backend/util/import-mongo/index.js

      - name: ğŸ”§ æ›´æ–° `.env`ï¼Œç§»é™¤ MongoDB ä¸¦æ·»åŠ  DynamoDB
        run: |
          cat <<EOF > giftlink-backend/.env
          DYNAMODB_TABLE=giftapp-data
          AWS_REGION=${{ secrets.AWS_REGION }}
          JWT_SECRET=mysecret
          EOF
          
      - name: ğŸ”§ æ›´æ–° `Dockerfile`
        run: |
          cat <<EOF > giftlink-backend/Dockerfile
          FROM node:18.12.1-bullseye-slim

          WORKDIR /usr/src/app

          COPY package*.json ./

          RUN npm install

          COPY . .

          # âœ… ç¢ºä¿ `gifts.json` å­˜åœ¨æ–¼ Docker Image
          RUN mkdir -p /usr/src/app/util/import-mongo
          COPY util/import-mongo/gifts.json /usr/src/app/util/import-mongo/gifts.json

          EXPOSE 3060

          CMD ["node", "app.js"]
          EOF

      - name: ğŸ”§ ä¿®æ­£ `db.js` è®€å– `gifts.json`
        run: |
          ls -al giftlink-backend/util/import-mongo/
          cat giftlink-backend/util/import-mongo/gifts.json
      - name: ğŸ”§ ä¿®æ­£ `db.js` è®€å– `gifts.json`
        run: |
          cat <<EOF > giftlink-backend/models/db.js
          require("dotenv").config();
          const fs = require("fs");
          const { join } = require("path");
          const { DynamoDBClient } = require("@aws-sdk/client-dynamodb");
          const { DynamoDBDocumentClient, ScanCommand, PutCommand } = require("@aws-sdk/lib-dynamodb");

          const client = new DynamoDBClient({ region: process.env.AWS_REGION || "us-east-1" });
          const dynamoDB = DynamoDBDocumentClient.from(client);
          const TABLE_NAME = process.env.DYNAMODB_TABLE || "giftapp-data";

          // **ä¿®æ­£ `gifts.json` è·¯å¾‘**
          const giftsFilePath = "/usr/src/app/util/import-mongo/gifts.json";
          if (!fs.existsSync(giftsFilePath)) {
            console.error("âŒ `gifts.json` ä¸å­˜åœ¨ï¼Œè«‹æª¢æŸ¥æ˜¯å¦å·²åŒ…å«åœ¨ Docker Image");
            process.exit(1);
          }

          const giftsData = JSON.parse(fs.readFileSync(giftsFilePath, "utf8")).docs;

          const db = {
            getGifts: async () => {
              const params = new ScanCommand({ TableName: TABLE_NAME });
              const data = await dynamoDB.send(params);
              return data.Items;
            },
            addGift: async (gift) => {
              const params = new PutCommand({ TableName: TABLE_NAME, Item: gift });
              await dynamoDB.send(params);
              return gift;
            },
            initializeData: async () => {
              const existingGifts = await db.getGifts();
              if (existingGifts.length === 0) {
                console.log("ğŸ”„ æ­£åœ¨å°å…¥ `gifts.json` åˆ° DynamoDB...");
                for (const gift of giftsData) {
                  await db.addGift(gift);
                }
                console.log("âœ… `gifts.json` æ•¸æ“šå·²æˆåŠŸå°å…¥ï¼");
              } else {
                console.log("âœ… `gifts.json` å·²å­˜åœ¨æ–¼ DynamoDBï¼Œè·³éå°å…¥ï¼");
              }
            }
          };

          module.exports = db;
          EOF


     
      - name: ğŸ”§ æ›´æ–° `app.js` ä¾†æ”¯æ´ DynamoDB
        run: |
          cat <<EOF > giftlink-backend/app.js
          const express = require("express");
          const cors = require("cors");
          const db = require("./models/db");

          const app = express();
          app.use("*", cors());
          app.use(express.json());

          const port = process.env.PORT || 3060;

          // ç¢ºä¿ API æ­£å¸¸é‹è¡Œ
          app.get("/", (req, res) => {
            res.send("Inside the server - Now using DynamoDB!");
          });

          // ç¢ºä¿å¯ä»¥è®€å–èˆ‡å¯«å…¥ DynamoDB
          app.get("/api/gifts", async (req, res) => {
            try {
              const gifts = await db.getGifts();
              res.json(gifts);
            } catch (error) {
              res.status(500).json({ error: error.message });
            }
          });

          app.post("/api/gifts", async (req, res) => {
            try {
              const newGift = req.body;
              await db.addGift(newGift);
              res.json({ message: "Gift added!", gift: newGift });
            } catch (error) {
              res.status(500).json({ error: error.message });
            }
          });

          app.listen(port, "0.0.0.0", () => {
            console.log("âœ… Server running on port", port);
            console.log("âœ… Using AWS DynamoDB Table:", process.env.DYNAMODB_TABLE);
          });
          EOF



      - name: âœ… ç¢ºä¿ AWS DynamoDB Table å­˜åœ¨
        run: |
          TABLE_NAME="giftapp-data"
          EXISTING_TABLE=$(aws dynamodb list-tables --query "TableNames" --output json | grep -w "$TABLE_NAME" || echo "")

          if [ -z "$EXISTING_TABLE" ]; then
            echo "ğŸ”„ å‰µå»º DynamoDB Table: $TABLE_NAME"
            aws dynamodb create-table \
              --table-name $TABLE_NAME \
              --attribute-definitions AttributeName=id,AttributeType=S \
              --key-schema AttributeName=id,KeyType=HASH \
              --billing-mode PAY_PER_REQUEST \
              --region ${{ secrets.AWS_REGION }}
            echo "âœ… DynamoDB Table å‰µå»ºæˆåŠŸï¼"
          else
            echo "âœ… DynamoDB Table $TABLE_NAME å·²å­˜åœ¨"
          fi

            
      - name: ğŸ” ç™»å½• AWS ECR
        run: |
          aws ecr get-login-password --region ${{ secrets.AWS_REGION }} | \
          docker login --username AWS --password-stdin \
          ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com  

      - name: ğŸ—ï¸ å»ºç«‹ Backend Docker Image ä¸¦æ¨é€åˆ° AWS ECR
        run: |
          docker buildx create --use
          docker buildx inspect --bootstrap
          docker buildx build --platform linux/amd64 \
            -t ${{ secrets.ECR_REPO }}/giftapp-backend:latest \
            --push ./giftlink-backend

      - name: ğŸš€ å‰µå»ºæˆ–æ›´æ–° App Runner æœå‹™
        run: |
          SERVICE_ARN=$(aws apprunner list-services --query "ServiceSummaryList[?ServiceName=='giftapp-backend'].ServiceArn" --output text --region ${{ secrets.AWS_REGION }})

          if [ -z "$SERVICE_ARN" ]; then
            echo "ğŸš€ å‰µå»ºæ–°çš„ App Runner æœå‹™..."
            aws apprunner create-service \
              --service-name giftapp-backend \
              --source-configuration '{
                "ImageRepository": {
                  "ImageIdentifier": "${{ secrets.ECR_REPO }}/giftapp-backend:latest",
                  "ImageRepositoryType": "ECR",
                  "ImageConfiguration": {
                    "Port": "3060",
                    "RuntimeEnvironmentVariables": {
                      "DYNAMODB_TABLE": "giftapp-data",
                      "AWS_REGION": "${{ secrets.AWS_REGION }}"
                    }
                  }
                },
                "AuthenticationConfiguration": {
                  "AccessRoleArn": "arn:aws:iam::253490795451:role/AppRunnerECRAccess"
                }
              }' \
              --region ${{ secrets.AWS_REGION }}
          else
            echo "ğŸ”„ æ›´æ–° App Runner æœå‹™..."
            aws apprunner update-service \
              --service-arn "$SERVICE_ARN" \
              --source-configuration '{
                "ImageRepository": {
                  "ImageIdentifier": "${{ secrets.ECR_REPO }}/giftapp-backend:latest",
                  "ImageRepositoryType": "ECR",
                  "ImageConfiguration": {
                    "Port": "3060"
                  }
                }
              }' \
              --AuthenticationConfiguration '{
                "AccessRoleArn": "arn:aws:iam::253490795451:role/AppRunnerECRAccess"
              }' \
              --region ${{ secrets.AWS_REGION }}
          fi


      - name: ğŸš€ éƒ¨ç½² Frontend åˆ° AWS App Runner
        run: |
          FRONTEND_ARN=$(aws apprunner list-services --query "ServiceSummaryList[?ServiceName=='giftwebsite'].ServiceArn" --output text --region ${{ secrets.AWS_REGION }})

          if [ -z "$FRONTEND_ARN" ]; then
            echo "ğŸ”„ å‰µå»º Frontend App Runner æœå‹™..."
            aws apprunner create-service \
              --service-name giftwebsite \
              --source-configuration '{
                "ImageRepository": {
                  "ImageIdentifier": "${{ secrets.ECR_REPO }}/giftwebsite:latest",
                  "ImageRepositoryType": "ECR",
                  "ImageConfiguration": {
                    "Port": "9000"
                  }
                },
                "AuthenticationConfiguration": {
                  "AccessRoleArn": "arn:aws:iam::253490795451:role/AppRunnerECRAccess"
                }
              }' \
              --region ${{ secrets.AWS_REGION }}
          else
            echo "ğŸ”„ æ›´æ–° Frontend App Runner æœå‹™..."
            aws apprunner update-service \
              --service-arn "$FRONTEND_ARN" \
              --source-configuration '{
                "ImageRepository": {
                  "ImageIdentifier": "${{ secrets.ECR_REPO }}/giftwebsite:latest",
                  "ImageRepositoryType": "ECR",
                  "ImageConfiguration": {
                    "Port": "9000"
                  }
                },
                "AuthenticationConfiguration": {
                  "AccessRoleArn": "arn:aws:iam::253490795451:role/AppRunnerECRAccess"
                }
              }' \
              --region ${{ secrets.AWS_REGION }}
          fi

      - name: å–å¾—æ‡‰ç”¨ç¨‹å¼ç¶²å€
        run: |
          BACKEND_URL=$(aws apprunner list-services --query "ServiceSummaryList[?ServiceName=='giftapp-backend'].ServiceUrl" --output text --region ${{ secrets.AWS_REGION }})
          FRONTEND_URL=$(aws apprunner list-services --query "ServiceSummaryList[?ServiceName=='giftwebsite'].ServiceUrl" --output text --region ${{ secrets.AWS_REGION }})

          echo "âœ… Backend URL: $BACKEND_URL"
          echo "âœ… Frontend URL: $FRONTEND_URL"
          echo "BACKEND_URL=$BACKEND_URL" >> $GITHUB_ENV
          echo "FRONTEND_URL=$FRONTEND_URL" >> $GITHUB_ENV

      - name: ğŸ“ æ›´æ–° README.md é¡¯ç¤ºç¶²ç«™ç¶²å€
        run: |
          echo "# ğŸ GiftWebsite" > README.md
          echo "" >> README.md
          echo "âœ… ä½ çš„ç¶²ç«™å·²éƒ¨ç½² ğŸ‰" >> README.md
          echo "" >> README.md
          echo 'ğŸ”— <a href="https://'$FRONTEND_URL'" target="_blank">**è¨ªå• GiftWebsite**</a>' >> README.md
          echo "" >> README.md
          echo "ğŸš€ æ¯æ¬¡ Push åˆ° main éƒ½æœƒè‡ªå‹•éƒ¨ç½²åˆ° AWS App Runnerï¼" >> README.md
          
          git config --global user.name 'github-actions'
          git config --global user.email 'github-actions@github.com'
          git add README.md
          git commit -m "æ›´æ–° README.mdï¼Œé¡¯ç¤ºæœ€æ–°çš„éƒ¨ç½²ç¶²å€"
          git push
